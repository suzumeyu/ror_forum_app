<div class="layout">

  <div class="posts">

    <article class="post-card post-show">

      <h2><%= @post.title %></h2>
      <p class="post-eta">
        by <%= @post.user.username %> - <%= time_ago_in_words(@post.created_at) %> ago
      </p>

      <div class="post-content">
        <%= @post.content %>
        <%= image_tag @post.image if @post.image.attached? %>
      </div>

      <div class="post-actions-container">
        <%= link_to "Back", posts_path, class: "back-btn" %>

        <% if authenticated? && (@post.user == Current.user || Current.user.privileged_user?) %>
          <div class="right-buttons">
            <%= link_to "Edit", edit_post_path(@post), class: "btn-edit" %>
            <%= button_to "Delete", @post, method: :delete,
                  data: { turbo_confirm: "Are you sure? This action cannot be undone." },
                  class: "btn-delete" %>
          </div>
        <% end %>
      </div>

    </article>

    <div class="section-divider"></div>

    <article class="post-card comments-card">
    
      <header class="comments-header">
        <h3>
          Comments
          <span class="comments-total">(<%= @comments.count %>)</span>
        </h3>

        <% if authenticated? %>
          <button id="show-comment-form" class="btn-primary">Add comment</button>
        <% else %>
          <span class="btn-placeholder"></span>
        <% end %>
      </header>

      <div class="comments-list">
        <turbo-frame id="comments">
          <% @comments.each do |comment| %>
            <turbo-frame id="comment_<%= comment.id %>">
              <%= render comment %>
            </turbo-frame>
          <% end %>
        </turbo-frame>
      </div>

      <% if authenticated? %>
        <turbo-frame id="new_comment_frame">
          <%= render "comments/form", comment: Comment.new(post: @post) %>
        </turbo-frame>
      <% end %>

    </article>

  </div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const showBtn = document.getElementById("show-comment-form");
    const commentFrame = document.getElementById("new_comment_frame");

    if(showBtn && commentFrame){
      showBtn.addEventListener("click", (e) => {
        e.preventDefault();
        commentFrame.style.display = "block";
        showBtn.style.display = "none";
      });
    }

    const cancelBtn = document.getElementById("cancel-comment-btn");
    if(cancelBtn && commentFrame && showBtn){
      cancelBtn.addEventListener("click", (e) => {
        e.preventDefault();
        commentFrame.style.display = "none";
        showBtn.style.display = "inline-block";
      });
    }
  });
</script>